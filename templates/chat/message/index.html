{% extends 'layouts/admin.html' %}
{% load static %}
{% block title %} Chat {% endblock %}
{% block content %}
<h4>Chat</h4>
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
    <li class="breadcrumb-item active" aria-current="page">Chat</li>
  </ol>
</nav>

<div class='card shadow-sm'>
  <div class='card-header pb-0 border-0'>
    <ul class='nav nav-tabs' id='search-tab' role='tablist'>
      <li class='nav-item' role='presentation'>
        <button class='nav-link active' id='sent-tab' data-bs-toggle='tab' data-bs-target='#sent' type='button' role='tab' aria-controls='sent' aria-selected='true'>
          <i class='bi bi-chat-dots me-1'></i> Sent ({{ sent_count }})
        </button>
      </li>
      <li class='nav-item' role='presentation'>
        <button class='nav-link' id='inbox-tab' data-bs-toggle='tab' data-bs-target='#inbox' type='button' role='tab' aria-controls='inbox' aria-selected='false'>
          <i class='bi bi-box me-1'></i> Inbox ({{ inbox_count }})
        </button>
      </li>
      <li class='nav-item' role='presentation'>
        <button class='nav-link' id='compose-tab' data-bs-toggle='tab' data-bs-target='#compose' type='button' role='tab' aria-controls='compose' aria-selected='false'>
          <i class='bi bi-plus-circle me-1'></i> Compose
        </button>
      </li>
    </ul>
  </div>
  <div class='card-body'>
    <div class='tab-content' id='tab-content'>
      <div class='tab-pane fade show active' id='sent' role='tabpanel' aria-labelledby='sent-tab'>
        {% for message in page_object %} {% if message.sender_id == request.user.id %}
        <div class='bg-light mb-2 py-2 px-3'>
          <i>{{ message.sender.email }} &rarr; {{ message.receiver_email }}</i>
          <i class='float-end'>{{ message.created_at|timesince }}</i> <br>
          {{ message.content|safe }}
        </div>
        {% endif %} {% endfor %}
      </div>
      <div class='tab-pane fade' id='inbox' role='tabpanel' aria-labelledby='inbox-tab'>
        {% for message in page_object %} {% if message.receiver == request.user.id %}
        <div class='bg-light mb-2 py-2 px-3'>
          <i>{{ message.sender.email }} &rarr; {{ message.receiver_email }}</i>
          <i class='float-end'>{{ message.created_at|timesince }}</i> <br>
          {{ message.content|safe }}
        </div>
        {% endif %} {% endfor %}
      </div>
      <div class='tab-pane fade' id='compose' role='tabpanel' aria-labelledby='compose-tab'>
        <form action="{% url 'chat:message.create' %}" method="post" enctype='multipart/form-data'>
          <div class='row'>
            <div class="col-md-6 mb-2">
              <label for="receiver" class="form-label">People</label>
              <input type="text" class="form-control" name="receiver" placeholder='person 1, person 2, person 3' />
            </div>
            <div class="col-md-6 mb-2">
              <label for="attachment" class="form-label">Attachment</label>
              <input type="file" class="form-control" name='attachment' accept='image/*' />
            </div>
          </div>
          <div class="mb-2">
            <label for="content" class="form-label">Content</label>
            <textarea id='editor' class='form-control' name='content' rows='5' placeholder="text message..."></textarea>
          </div>
          {% csrf_token %}
          <div class='d-flex justify-content-between'>
            <button class="btn btn-primary" type="submit">Continue</button>
            <a class="btn btn-link" href="{% url 'chat:message.index' %}">All sent</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block styles %}
<link href="{% static 'css/tagify.css' %}" rel="stylesheet" type="text/css" />
{% endblock %}
{% block scripts %}
<script src="{% static 'js/tagify.js' %}"></script>
<script src="{% static 'js/ckeditor.js' %}"></script>
<script src="{% static 'js/tagify.polyfills.min.js' %}"></script>
<script>
  let list = {{ users|safe }}
  ClassicEditor.create(document.querySelector('#editor'))
  let input = document.querySelector('input[name=receiver]');
  new Tagify(input, {enforceWhitelist: true, whitelist: list.map(item => item?.fields?.email) })
</script>
{% endblock %}